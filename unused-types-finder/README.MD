## Назначение скрипта

Этот XQuery-скрипт предназначен для анализа набора XML Schema Definition (XSD) файлов с целью выявления типов, объявленных в основном схеме `xsd`, которые **не используются ни в одном из других связанных XSD-файлов**. Это позволяет определить "мертвый код" — типы, которые были объявлены, но фактически не задействованы в остальной части схемы.

Такой анализ полезен при:
- Очистке и рефакторинге больших проектов XSD.
- Уменьшении сложности схемы за счет удаления ненужных элементов.
- Проверке целостности и актуальности схемы после изменений.
- Подготовке к миграции или документированию структуры данных.

---

## Как работает скрипт

### 1. Загрузка всех XSD-файлов
Скрипт начинает с загрузки списка основных XSD-файлов, указанных в переменной `$main-files`. Он рекурсивно обрабатывает все `<xs:include>` ссылки, чтобы построить полный граф зависимостей между схемами.

Для каждой схемы:
- Файл загружается через `doc()`.
- Все его `<include schemaLocation="..."/>` разрешаются (с учетом базового пути).
- Включаемые файлы добавляются в очередь на обработку, если они еще не загружены.

В результате создается единый кэш всех схем (`$all-schemas-cache`), участвующих в проекте.

---

### 2. Построение индекса типов
Создается карта (`map`) под названием `$type-index`, где:
- **Ключ**: полное имя типа в формате `{namespace}имя` (например, `{http://example.com/ns}MyType`).
- **Значение**: запись с двумя полями:
  - `node`: сам элемент схемы (`<xs:simpleType>` или `<xs:complexType>`),
  - `schema`: ссылка на родительскую схему (для контекста пространства имен).

Это позволяет быстро находить определение любого типа по его имени.

---

### 3. Извлечение объявлений из `xsd`
Из основного файла `xsd` извлекаются все именованные типы (`simpleType` и `complexType`), также преобразованные в формат `{namespace}имя`.

---

### 4. Поиск всех ссылок на типы во всех других схемах
Для каждой схемы, **кроме** `xsd`, скрипт выполняет глубокий анализ всех возможных ссылок на типы, включая:

- Атрибуты: `@type`, `@base`, `@itemType`, `@memberTypes`
- Элементы: `<xs:element>`, `<xs:attribute>`, `<xs:restriction>`, `<xs:extension>`, `<xs:list>`, `<xs:union>`

Используется функция `local:deep-extract-type-references`, которая:
- Обходит дерево схемы в ширину (BFS-подобный подход через стек),
- Нормализует имена типов с учетом пространств имен,
- Рекурсивно раскрывает зависимости (например, если тип A использует B, а B использует C — все будут найдены).

Результат — список всех типов, на которые есть прямые или косвенные ссылки в других схемах.

---

### 5. Определение неиспользуемых типов
Финальный шаг — сравнение:
- Объявленные типы в `xsd` → `$ndc-declared-types`
- Типы, на которые есть ссылки в других файлах → `$other-type-references`

Неиспользуемые типы — это те, что есть в первом списке, но отсутствуют во втором:
```xquery
$ndc-declared-types[not(. = $other-type-references)]
```

## Результат
```
<result>
  <summary>Declared in xsd but NOT USED elsewhere: N</summary>
  <unusedTypes>
    <type>TypeName1</type>
    <type>TypeName2</type>
    ...
  </unusedTypes>
</result>
```
